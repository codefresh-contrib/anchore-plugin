version: '1.0'
steps:
  BuildImage:
    title: Building Docker Image
    type: build
    image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
  TestSuccess:
    title: Running basic test
    type: composition
    environment_name: anchore_engine
    composition: testing/docker-compose.yaml
    description: This should succeed
    composition_candidates:
    test_service:
      image: ${{BuildImage}}
      environment:
        - ANCHORE_CLI_IMAGE=alpine
        - ANCHORE_CLI_URL=http://anchore-engine::8228/v1
        - ANCHORE_CLI_FAIL_ON_POLICY=true
  TestFailure:
    fail_fast: false
    title: Running failure test
    description: This should fail
    type: composition
    environment_name: anchore_engine
    composition: testing/docker-compose.yaml
    composition_candidates:
    test_service:
      image: ${{BuildImage}}
      environment:
        - ANCHORE_CLI_IMAGE=alpine
        - ANCHORE_CLI_URL=http://anchore-engine::8228/v1
        - ANCHORE_CLI_FAIL_ON_POLICY=true
  PushingToRegistry:
    type: push
    title: Pushing To Registry
    candidate: ${{BuildImage}}
    tag: '${{CF_BRANCH}}'
